<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Certificate Verification</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .verify-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .verify-header {
        text-align: center;
        margin-bottom: 2rem;
      }
      .verify-header h1 {
        color: #111827;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .verify-header p {
        color: #374151;
        font-weight: 500;
        font-size: 1.1rem;
      }
      .verify-form {
        margin-bottom: 2rem;
      }
      .verify-result {
        margin-top: 2rem;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid;
      }
      .verify-result.valid {
        background: #f0fdf4;
        border-color: #22c55e;
        color: #166534;
      }
      .verify-result.invalid {
        background: #fef2f2;
        border-color: #ef4444;
        color: #991b1b;
      }
      .certificate-details {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 6px;
      }
      .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }
      .detail-label {
        font-weight: 600;
      }
      .detail-value {
        color: #111827;
        font-weight: 600;
      }
      .verify-form label span {
        color: #111827;
        font-weight: 600;
      }
      input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
        border-color: #d1d5db;
        color: #374151;
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <main style="padding: 2rem;">
        <div class="verify-container">
          <div class="verify-header">
            <h1>Certificate Verification</h1>
            <p>Verify the authenticity of certificates issued by Certificate Desk</p>
          </div>

          <div id="verify-intro">
            <button id="show-verify-form" class="btn-primary" style="display: block; margin: 0 auto; padding: 1rem 2rem; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
              Verify Certificate
            </button>
          </div>

          <div id="verify-form-container" style="display: none;">
            <div class="verify-form">
              <form id="verify-form">
                <label>
                  <span>Certificate ID</span>
                  <input 
                    type="text" 
                    name="certificateId" 
                    placeholder="Certificate ID will be auto-filled from QR code or verification link"
                    readonly
                    required 
                  />
                </label>
                <button type="submit">Verify Certificate</button>
              </form>
            </div>

            <div id="verify-result"></div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const apiBase = '/api';
      const verifyForm = document.getElementById('verify-form');
      const verifyResult = document.getElementById('verify-result');
      const showVerifyFormBtn = document.getElementById('show-verify-form');
      const verifyFormContainer = document.getElementById('verify-form-container');
      const verifyIntro = document.getElementById('verify-intro');

      // Show verification form when button is clicked
      if (showVerifyFormBtn) {
        showVerifyFormBtn.addEventListener('click', () => {
          verifyIntro.style.display = 'none';
          verifyFormContainer.style.display = 'block';
        });
      }

      async function fetchJSON(path, options = {}) {
        const res = await fetch(`${apiBase}${path}`, {
          headers: {
            'Content-Type': 'application/json',
            ...(options.headers || {}),
          },
          ...options,
        });
        const payload = await res.json().catch(() => null);
        if (!res.ok) {
          throw new Error(payload?.error || 'Request failed');
        }
        return payload?.data ?? payload;
      }

      function showResult(data) {
        if (!verifyResult) return;
        
        const isValid = data.valid;
        const resultClass = isValid ? 'valid' : 'invalid';
        
        let html = `
          <div class="verify-result ${resultClass}">
            <h3>${isValid ? 'Certificate Verified' : 'Certificate Invalid'}</h3>
            <p>${data.reason || (isValid ? 'This certificate is authentic and valid.' : '')}</p>
        `;

        if (isValid && data.certificate) {
          html += `
            <div class="certificate-details">
              <h4>Certificate Details:</h4>
              <div class="detail-row">
                <span class="detail-label">Certificate ID:</span>
                <span class="detail-value"><strong>${data.certificate.certificate_full_id}</strong></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Participant Name:</span>
                <span>${data.certificate.participant_name}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Template:</span>
                <span>${data.certificate.template_name}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span>${data.certificate.status}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Delivery Status:</span>
                <span>${data.certificate.delivery_status}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Created:</span>
                <span>${new Date(data.certificate.created_at).toLocaleString()}</span>
              </div>
              ${data.certificate.qr_code_path ? `
              <div class="detail-row">
                <span class="detail-label">QR Code:</span>
                <span><img src="/api/certificates/${data.certificate.id}/qr" alt="QR Code" style="max-width: 150px; height: auto;" /></span>
              </div>
              ` : ''}
              ${data.certificate.verification_url ? `
              <div class="detail-row">
                <span class="detail-label">Verification URL:</span>
                <span><a href="${data.certificate.verification_url}" target="_blank">${data.certificate.verification_url}</a></span>
              </div>
              ` : ''}
            </div>
          `;
        }

        html += '</div>';
        verifyResult.innerHTML = html;
      }

      if (verifyForm) {
        verifyForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const formData = new FormData(verifyForm);
          const certificateId = formData.get('certificateId').trim();
          
          if (!certificateId) {
            verifyResult.innerHTML = '<div class="verify-result invalid"><p>Certificate ID is required. Please access this page through a QR code or verification link.</p></div>';
            return;
          }

          try {
            verifyResult.innerHTML = '<div class="verify-result"><p>Verifying...</p></div>';
            const data = await fetchJSON(`/certificates/${certificateId}/verify`);
            showResult(data);
          } catch (err) {
            verifyResult.innerHTML = `
              <div class="verify-result invalid">
                <h3>Verification Failed</h3>
                <p>${err.message || 'Certificate not found or access denied. Please ensure you have a valid QR code or verification link.'}</p>
              </div>
            `;
          }
        });

        // Auto-verify if certificate ID is in URL
        const urlParams = new URLSearchParams(window.location.search);
        const certId = urlParams.get('id');
        
        if (certId) {
          // Show the form first
          verifyIntro.style.display = 'none';
          verifyFormContainer.style.display = 'block';
          
          // Fill the certificate ID and auto-verify
          document.querySelector('input[name="certificateId"]').value = certId;
          verifyForm.dispatchEvent(new Event('submit'));
        }
      }
    </script>
  </body>
</html>
